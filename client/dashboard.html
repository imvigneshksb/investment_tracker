<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Investment Tracker</title>
    <link rel="stylesheet" href="css/styles.css" />
    <script>
      // Check if user is logged in, if not redirect to login
      (async function () {
        try {
          const response = await fetch("/api/auth/verify", {
            credentials: 'include'
          });
          
          if (!response.ok) {
            // User not authenticated, redirect to login
            window.location.href = "login.html";
          }
        } catch (error) {
          console.error("Auth check error:", error);
          // On error, redirect to login
          window.location.href = "login.html";
        }
      })();
    </script>
  </head>
  <body>
    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Header -->
    <header class="main-header">
      <div class="header-content">
        <h1 class="logo" onclick="goToHomePage()" tabindex="0">
          Investment Tracker
        </h1>
        <div class="header-profile">
          <div
            class="profile-icon"
            id="profileIcon"
            onclick="toggleProfileMenu()"
          >
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <circle
                cx="12"
                cy="8"
                r="4"
                stroke="currentColor"
                stroke-width="2"
                fill="none"
              />
              <path
                d="M20 21a8 8 0 1 0-16 0"
                stroke="currentColor"
                stroke-width="2"
                fill="none"
              />
            </svg>
          </div>
          <div class="dropdown" id="profileDropdown" style="display: none">
            <div class="profile-info">
              <div class="profile-name" id="profileName">User Name</div>
              <div class="profile-email" id="profileEmail">user@email.com</div>
            </div>
            <hr class="profile-divider" />
            <div class="profile-menu-item" onclick="showProfileSettings()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
                <circle
                  cx="12"
                  cy="12"
                  r="3"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
              </svg>
              Profile Settings
            </div>
            <div class="profile-menu-item" onclick="logout()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
                <polyline
                  points="16,17 21,12 16,7"
                  stroke="currentColor"
                  stroke-width="2"
                  fill="none"
                />
                <line
                  x1="21"
                  y1="12"
                  x2="9"
                  y2="12"
                  stroke="currentColor"
                  stroke-width="2"
                />
              </svg>
              Logout
            </div>
          </div>
        </div>
      </div>
    </header>

    <div class="single-column-container">
      <!-- Main Dashboard Content -->
      <div id="dashboardContent">
        <!-- Action Buttons Section -->
        <section class="navigation-section">
          <h2 class="section-title">Navigation</h2>
          <div class="action-buttons">
            <button class="action-btn">Portfolio</button>
            <button class="action-btn">Analytics</button>
            <button class="action-btn">Settings</button>
          </div>
        </section>

        <!-- Portfolio Summary Section -->
        <section class="portfolio-summary">
          <h2 class="section-title">Portfolio Summary</h2>
          <div class="summary-cards">
            <div class="data-card">
              <h3>Portfolio Value</h3>
              <p class="value" id="portfolioValue">$0</p>
            </div>

            <div class="data-card">
              <h3>Daily Change</h3>
              <p class="value" id="dailyChange">$0</p>
            </div>

            <div class="data-card">
              <h3>Total Gain</h3>
              <p class="value" id="totalGain">0%</p>
            </div>
          </div>
        </section>

        <!-- Chart Section -->
        <!-- Chart Section -->
        <section class="chart-section">
          <div class="chart-header">
            <h2 class="section-title">Investment Performance</h2>
            <div class="chart-controls">
              <button class="time-btn active">1W</button>
              <button class="time-btn">1M</button>
              <button class="time-btn">3M</button>
              <button class="time-btn">1Y</button>
              <button class="time-btn">ALL</button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="investmentChart"></canvas>
          </div>
        </section>

        <!-- Recent Transactions Section -->
        <section class="transactions-section">
          <h2 class="section-title">Recent Transactions</h2>
          <div class="dashboard-card">
            <div class="transaction-list" id="transactionList">
              <!-- Transactions will be loaded dynamically -->
              <div class="no-data">No transactions yet</div>
            </div>
          </div>
        </section>

        <!-- Holdings Section -->
        <section class="holdings-section">
          <h2 class="section-title">Holdings</h2>

          <!-- Stocks Holdings -->
          <div class="holdings-category">
            <div class="category-header">
              <h3 class="category-title">Stocks</h3>
              <button
                class="btn-primary add-category-btn btn-small btn-auto-width"
                onclick="showAddStockModal()"
              >
                Add Stock
              </button>
            </div>
            <div class="holdings-container">
              <div class="holdings-table">
                <div class="holdings-header">
                  <div class="holding-col">Symbol</div>
                  <div class="holding-col">Company</div>
                  <div class="holding-col">Qty</div>
                  <div class="holding-col">Avg Price</div>
                  <div class="holding-col">Current Price</div>
                  <div class="holding-col">Investment</div>
                  <div class="holding-col">Current Value</div>
                  <div class="holding-col">Gain/Loss</div>
                  <div class="holding-col">Return %</div>
                  <div class="holding-col">Actions</div>
                </div>
                <div class="holdings-body" id="stocksTableBody">
                  <div class="no-holdings">
                    <p>No stocks in portfolio</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Mutual Funds Holdings -->
          <div class="holdings-category">
            <div class="category-header">
              <h3 class="category-title">Mutual Funds</h3>
              <button
                class="btn-primary add-category-btn btn-small btn-auto-width"
                onclick="showAddMutualFundModal()"
              >
                Add Mutual Fund
              </button>
            </div>
            <div class="holdings-container">
              <div class="holdings-table">
                <div class="holdings-header">
                  <div class="holding-col">Scheme</div>
                  <div class="holding-col">Fund Name</div>
                  <div class="holding-col">Units</div>
                  <div class="holding-col">Avg NAV</div>
                  <div class="holding-col">Current NAV</div>
                  <div class="holding-col">Investment</div>
                  <div class="holding-col">Current Value</div>
                  <div class="holding-col">Gain/Loss</div>
                  <div class="holding-col">Return %</div>
                  <div class="holding-col">Actions</div>
                </div>
                <div class="holdings-body" id="mutualFundsTableBody">
                  <div class="no-holdings">
                    <p>No mutual funds in portfolio</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Market Summary Section -->
        <section class="market-section">
          <h2 class="section-title">Market Summary</h2>
          <div class="dashboard-card">
            <div class="market-stats" id="marketStats">
              <!-- Market data removed - offline mode -->
              <div class="no-data">
                Market data not available in offline mode
              </div>
            </div>
          </div>
        </section>
      </div>
      <!-- End Dashboard Content -->
    </div>

    <script src="js/script.js"></script>
    <script>
      // Initialize dashboard when page loads
      document.addEventListener('DOMContentLoaded', function() {
        // Update header profile visibility
        updateHeaderProfile();
        
        // Load user portfolio data
        const currentSession = getCurrentSession();
        if (currentSession) {
          loadUserPortfolio(currentSession.email);
          
          // Initialize chart after a short delay
          setTimeout(() => {
            drawChart();
          }, 100);
        }
      });
    </script>
  </body>
</html>
